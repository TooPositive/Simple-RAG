graph TB
    subgraph "User Interface"
        CLI[Interactive CLI<br/>Context-Aware Conversations<br/>Displays Reasoning & Reflection]
        API[API Endpoint - Optional]
    end
    
    subgraph "Conversation Management"
        ContextTracker[Context Tracker<br/>- repo_context_active flag<br/>- Cached repo data<br/>- last_task_type]
        TaskDetector[Smart Task Detector<br/>- Prioritizes content generation<br/>- Detects follow-up questions<br/>- Code-specific query detection]
    end

    subgraph "LangGraph Agent Orchestrator - Single Pass Workflow"
        Entry[Entry Point<br/>iteration_count = 0]
        Planner[Planning Node<br/>- Analyzes task type<br/>- Determines approach<br/>- Checks cached data]
        RepoAnalyzer[Repository Analyzer (EVIDENCE-BASED)<br/>- AST Parsing: Extract classes, functions, tests<br/>- Verification Commands:<br/>  * pytest --collect-only (actual test count)<br/>  * coverage run + report (actual %)<br/>  * find tests (test file count)<br/>- Stores: code_symbols, verification_outputs<br/>- No hallucination - all data is real]
        RAGRetriever[RAG Retrieval Node<br/>- Vector similarity search<br/>- ChromaDB integration]
        Reasoner[Reasoning Node<br/>- GPT-4o Chain-of-Thought<br/>- 3-5 reasoning steps<br/>- Context-aware analysis]
        Reflector[Reflection Node (CRITICAL)<br/>- GPT-4o Self-Critique (temp=0.3)<br/>- Evidence checks for repo analysis<br/>- Demands: code symbols, test refs, versions<br/>- Assessment: good/needs_improvement<br/>- Finds real gaps and weaknesses<br/>- ALWAYS proceeds to generator]
        Generator[Generation Node (EVIDENCE-BASED)<br/>- IF needs_improvement:<br/>  * Generate BEFORE (baseline)<br/>  * Generate AFTER (improved)<br/>  * Show comparison<br/>- ELSE: Generate once<br/>- Evidence-based prompts (no vague claims)<br/>- Requires: class/function names, test citations<br/>- Prohibits: "likely", "suggests", "appears to"<br/>- Context-aware output]
        Evaluator[Evaluation Node (RIGOROUS)<br/>- Task-aware scoring<br/>- 5 Metrics with explanations<br/>- Evidence-based for repo analysis<br/>- Rewards: code symbols, test refs, versions<br/>- Penalizes: vague language (-10 pts)<br/>- WHY THESE SCORES? breakdown]
        Exit[Exit Point<br/>Returns AgentState]
    end

    subgraph "Agent State Management"
        State[(Agent State (17+ fields)<br/>- task & task_type<br/>- reasoning_steps list<br/>- reflection_notes list<br/>- reflection_assessment<br/>- tool_usage list<br/>- repo_structure dict<br/>- code_files list with content<br/>- dependencies dict<br/>- architecture dict<br/>- code_symbols dict (AST extraction)<br/>- verification_outputs dict (pytest, coverage)<br/>- retrieved_context (RAG)<br/>- output_before_reflection<br/>- final_output<br/>- evaluation_scores<br/>- evaluation_explanations<br/>- iteration_count)]
    end

    subgraph "Tool Ecosystem"
        RepoTools[Repository Analysis Tools<br/>4 tools for code inspection]
        RAGTools[RAG Tools v1.0<br/>Vector search & retrieval]
        GenTools[Generation Tools<br/>Content formatting]
        EvalTools[Evaluation Tools (NEW!)<br/>Quality metrics + explanations]
    end

    subgraph "Repository Analysis Tools - Code Understanding"
        DirStructure[1. Directory Structure<br/>- Scans file tree<br/>- Returns hierarchy]
        FileReader[2. Source File Reader<br/>- Reads .py files<br/>- Extracts content<br/>- For code-specific queries]
        DepExtractor[3. Dependency Extractor<br/>- Parses requirements.txt<br/>- Returns library list]
        ArchMapper[4. Architecture Mapper<br/>- Identifies modules<br/>- Maps relationships]
    end

    subgraph "RAG System v1.0"
        VectorStore[(ChromaDB<br/>Vector Store)]
        Embeddings[Azure OpenAI<br/>Embeddings]
        Chatbot[RAG Chatbot<br/>Q&A Engine]
    end

    subgraph "Generation Tools - Context-Aware Output"
        MarkdownGen[Markdown Generator<br/>- Formats repo analysis<br/>- Structure reports]
        LinkedInGen[LinkedIn Post Generator<br/>- Uses repo context<br/>- Data-driven content<br/>- Mentions tech stack]
        CodeExcerpt[Code Excerpt Extractor<br/>- Finds relevant files<br/>- Extracts imports & definitions<br/>- For code-specific answers]
    end

    subgraph "External Services - LLM Integration"
        AzureOpenAI[Azure OpenAI GPT-4o<br/>- Reasoning: temp=0.7<br/>- Reflection: temp=0.3<br/>- Generation: temp=0.5]
        LangSmith[LangSmith<br/>Observability & Tracing]
    end

    subgraph "Data Sources"
        RepoFS[(Repository<br/>File System)]
        KnowledgeBase[(Knowledge Base<br/>Documents)]
    end

    %% User interactions with context management
    CLI --> ContextTracker
    CLI --> TaskDetector
    ContextTracker --> TaskDetector
    TaskDetector --> Entry
    API -.-> Entry

    %% Agent flow with detailed annotations
    Entry --> Planner
    Planner -->|Analyze Code:<br/>repo analysis task| RepoAnalyzer
    Planner -->|Search Knowledge:<br/>RAG query| RAGRetriever
    Planner -->|Direct Reasoning:<br/>simple query| Reasoner
    
    RepoAnalyzer -->|Repo data populated| Reasoner
    RAGRetriever -->|Context retrieved| Reasoner
    
    Reasoner -->|Reasoning steps<br/>added to state| Reflector
    
    Reflector -->|Self-critique note<br/>ALWAYS proceeds| Generator
    
    Generator -->|Uses reflection<br/>to improve output| Evaluator
    
    Evaluator -->|5-metric scores| Exit
    Exit --> CLI

    %% State connections
    Planner <--> State
    RepoAnalyzer <--> State
    RAGRetriever <--> State
    Reasoner <--> State
    Reflector <--> State
    Generator <--> State
    Evaluator <--> State

    %% Tool connections
    RepoAnalyzer --> RepoTools
    RAGRetriever --> RAGTools
    Generator --> GenTools
    Evaluator --> EvalTools

    %% Repository tools
    RepoTools --> DirStructure
    RepoTools --> FileReader
    RepoTools --> DepExtractor
    RepoTools --> ArchMapper

    %% RAG tools
    RAGTools --> VectorStore
    RAGTools --> Embeddings
    RAGTools --> Chatbot

    %% Generation tools
    GenTools --> MarkdownGen
    GenTools --> LinkedInGen
    GenTools --> CodeExcerpt

    %% Data source connections
    DirStructure --> RepoFS
    FileReader --> RepoFS
    DepExtractor --> RepoFS
    Chatbot --> KnowledgeBase
    VectorStore --> KnowledgeBase

    %% External service connections
    Planner -.-> AzureOpenAI
    Reasoner -.-> AzureOpenAI
    Reflector -.-> AzureOpenAI
    Generator -.-> AzureOpenAI
    Evaluator -.-> AzureOpenAI
    Embeddings -.-> AzureOpenAI
    
    Entry -.-> LangSmith
    Exit -.-> LangSmith

    %% Styling
    classDef agentNode fill:#e1f5ff,stroke:#01579b,stroke-width:2px
    classDef toolNode fill:#f3e5f5,stroke:#4a148c,stroke-width:2px
    classDef dataNode fill:#e8f5e9,stroke:#1b5e20,stroke-width:2px
    classDef externalNode fill:#fff3e0,stroke:#e65100,stroke-width:2px
    classDef uiNode fill:#fff9c4,stroke:#f57f17,stroke-width:2px
    
    class Planner,RepoAnalyzer,RAGRetriever,Reasoner,Reflector,Generator,Evaluator agentNode
    class RepoTools,RAGTools,GenTools,DirStructure,FileReader,DepExtractor,ArchMapper,MarkdownGen,LinkedInGen,CodeExcerpt,EvalTools toolNode
    class State,VectorStore,RepoFS,KnowledgeBase dataNode
    class AzureOpenAI,LangSmith externalNode
    class CLI,ContextTracker,TaskDetector uiNode
    
    %% KEY FEATURES (v2.0):
    %% 1. Reasoning & Reflection: Reasoner → Reflector → Generator (passes critique forward)
    %% 2. BEFORE/AFTER Demo: Shows baseline vs improved when assessment is "needs_improvement"
    %% 3. Critical Self-Assessment: Finds real issues, no fake improvements
    %% 4. Transparent Evaluation: Task-aware scoring with detailed "WHY THESE SCORES?" explanations
    %% 5. Evidence-Based Analysis: Demands concrete code refs, test citations, dependency versions
    %% 6. Rigorous Scoring: Rewards evidence, penalizes vague language ("likely", "suggests", etc.)
    %% 7. RAG Integration: ChromaDB retrieval node for knowledge base questions
    %% 8. Code Understanding: FileReader extracts actual source code for code-specific queries
    %% 9. Context-Aware: Cached repo data, follow-up question detection
    %% 10. Data-Driven LinkedIn Posts: Uses actual dependencies and modules from repo analysis
    %% 11. Max 1 Iteration: Single pass workflow, no unnecessary loops
    %% 12. Visible Reasoning: CLI shows chain-of-thought and self-critique in real-time
